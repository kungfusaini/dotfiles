(self.webpackChunk=self.webpackChunk||[]).push([[748],{58155:(e,t,i)=>{i.r(t),i.d(t,{GhostFieldIntegration:()=>Y});var s=i(90023),n=i(48546),r=i(72234),a=i(25437),h=i(13391),c=i(62552),o=i(90572),l=i(84178),_=i(9273),d=i(53976),g=i(59179),p=i(14969),u=i(58303),v=i(84358),b=i(88347),S=i(20302),x=i(75454),C=i(5143),k=i(60774),m=i(23031),f=i(8261),T=i(25271),y=i(33487),w=i(97472),D=i(17265),A=i(29561),E=i(22003),F=i(99454),P=i(75777),U=i(60108),B=i(25961),I=i(65051),O=i(57462),R=i(84322),M=i(28625),G=i(47903),z=i(13272),H=i(47230),q=i(20182),N=i(81356);class Y{constructor({doc:e,textField:t,domain:i,layout:r,createCheckingService:_,state:d,gnar:g,felog:p,textObserver:v,experimentClient:b,createTextRevisionManager:S=(e=>G.n.create(e)),originalTextField:x=t,textEventsTarget:C,customizations:m={},mapChange:f=s.yR,integrationName:y,fieldIntegrationStore:w}){this._initialSessionUUID=h.h.create(u.YP),this._disposables=[],this._checkingService=h.h.create(null),this._sduiBufferService=h.h.create(u.YP),this._publishedAckReceived=new c.X(!1),this._canDisposeCheckingService=new c.X(!1),this._canDisposeCheckingServicePromise=(0,n.n)(this._canDisposeCheckingService.pipe(o.h((e=>e)),l.q(1))),this._checkingStatus=h.h.create(U.H.idle),this._readyState=h.h.create(B.kQ.notReady),this._nativeSpellcheckEnabled=h.h.create(!1),this._generalScore=h.h.create(null),this._lowestGeneralScore=h.h.create(null),this._paragraphsCount=h.h.create(0),this._formattingSpansCount=h.h.create(0),this._requestAwaitService=new I.e,this._capiStartAckMessage=h.h.create(u.YP),this._isDisposed=!1,this._subs=[],this._domain=i,this._layout=r,this._createCheckingService=_,this._state=d,this._gnar=g,this._felog=p,this._textObserver=v,this._createTextRevisionManager=S,this._originalTextField=x,this._textEventsTarget=C,this._customizations=m,this._experimentClient=b,this._initialWebkitUserSelect=this._originalTextField.style.webkitUserSelect,this._mapChange=f,this._integrationName=y,this._textRevisionManager=this._createTextRevisionManager(v),this._disposables.push(this._textRevisionManager),this._disposables.push(this._alertProcessor),this._disposables.push(this._userEngagedByAlertsAcceptedService),this._doc=F.v.createOnCapi(e,{selectedLens:a.R.SpecialId.AllAlerts}),this._fieldIntegrationStore=w;const D=this._state.get().dynamicConfig.dlpEnabled&&"enabled"===this._experimentClient.getTreatment(H.p.ClientControlsDlpBuffering),P=this._experimentClient.isGateEnabled(q.K.TextChangeBufferUseLegacy),O=this._textObserver.getCurrentTextMap().getPlainText();this._alertProcessor=T.B.create(O,this._textRevisionManager,p);const z=R.ft,N=P?new M.R(this.getUnmappedTextObserver().contentChanges.async,D?void 0:(0,k.qw)(this._originalTextField),!!this._customizations.richText,z):new R.fM(this.getUnmappedTextObserver().contentChanges.async,this._alertProcessor,D?void 0:(0,k.qw)(this._originalTextField),!!this._customizations.richText,z,!this._experimentClient.isGateEnabled(q.K.TextChangeBufferDontFlushOnApply));this._textChangeBuffer=N,this._disposables.push(N),this._textFieldAttrs=new A.Y(this._originalTextField,{spellcheck:"false"}),this._subs.push((0,E.H)({checkingService:this._checkingService,highlights:this._highlights,layout:this._layout,experimentClient:this._experimentClient,getAlertById:e=>this._alertProcessor.alerts.getAlertById(e)}).subscribe()),this._disposables.push(this._textFieldAttrs),Promise.resolve().then((()=>this._delayedStart()))}_isGBSigninCheckTextDisabled(){var e;const{user:t,page:i}=this._state.get();return(0,O.K)(t,i)&&(null!==(e=i.hideGBSigninPopupTodayTimestamp)&&void 0!==e?e:0)>Date.now()-r.pU}_delayedStart(){const{user:e,page:t}=this._state.get();N.n.isEdcBlocked(e)||this._isGBSigninCheckTextDisabled()||this._startCheckingText(!0===t.showOnboarding)}update(e){const t=this._checkingService.get();if(N.n.isEdcBlocked(e.user)||this._isGBSigninCheckTextDisabled())return null!==t&&(this._alertProcessor.removeAllAlerts({_tag:y.i.reset}),t.closeConnection(),this._checkingService.set(null)),void this._state.set(e);if(null!==t){const i=e.user,s=e.dapi.dialectStrong,n=this._state.get(),r=n.user,a=n.dapi.dialectStrong;i.id!==r.id||i.type!==r.type?(t.reconnect(),this._alertProcessor.removeAllAlerts({_tag:y.i.reset})):s!==a&&this._doc.settings.modify((e=>{const t={...e.context,dialect:u.ij(s)};return{...e,context:t}}))}else"ready"===e.extensionFSM.stage&&this._startCheckingText(!0===e.page.showOnboarding);this._state.set(e)}dispose(){var e;this._isDisposed||(this._isDisposed=!0,this._subs.forEach((e=>e.unsubscribe())),this._originalTextField.style.webkitUserSelect=this._initialWebkitUserSelect,[...this._disposables,this._textObserver,this._layout.textField.scroller].forEach((e=>{try{null==e||e.dispose()}catch(e){}})),null===(e=this._checkingService.get())||void 0===e||e.dispose(),_.timer(1e3).pipe(d.c(this._publishedAckReceived)).subscribe((e=>{e||this._canDisposeCheckingService.next(!0)})))}_startCheckingText(e){var t;if(null!==this._checkingService.get())return;const i=this._createCheckingService({doc:this._doc,mapChange:this._mapChange,integrationName:this._integrationName});this._checkingService.set(i),i.delayDisposeUntil(this._canDisposeCheckingServicePromise),this._subs.push(i.capiMessages.pipe(o.h((e=>"start"===e.action))).subscribe((e=>this._capiStartAckMessage.set(u.G(e))))),this._subs.push(i.capiEvents.pipe(o.h(S.hX.is("session_started"))).subscribe((e=>{this._initialSessionUUID.set(u.ij(e.sessionUuid))})));this._disposables.push(this._fieldIntegrationStore.registerFieldIntegration(x.O.ghost,null!==(t=this._textEventsTarget)&&void 0!==t?t:this._originalTextField,this._integrationName,this._textObserver)),this._checkingFeatureImpl=new D.O(this._state.view("user"),this._alertProcessor,i,this.getUnmappedTextObserver(),this._textRevisionManager,(()=>{}),(e=>this._checkingStatus.set(e)),(e=>this._readyState.set(e)),(e=>{this._fieldIntegrationController.setSiteSettings(e),this._checkDocContextSubscription()}),(e=>{this._textFieldAttrs.setAttributes({spellcheck:e.toString()}),this._nativeSpellcheckEnabled.set(e)}),((e,t,i)=>{}),(e=>(0,s.zG)(v.cS)),!!this._customizations.richText,(e=>this._generalScore.set(e||null)),(e=>this._lowestGeneralScore.set(e||null)),(e=>this._paragraphsCount.set(e)),(e=>this._formattingSpansCount.set(e)),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(()=>{(0,f.OB)().bgRpc.api.refreshUser("not_authorized")}),(e=>{this._statisticsService.wordsCount.set(e.wordsCount),this._statisticsService.charsCount.set(e.charsCount),this._statisticsService.sessionStats.set(e.sessionStats)}),(e=>{}),(e=>{}),(()=>this._canDisposeCheckingService.next(!0)),this._requestAwaitService.requests,this._textChangeBuffer,this._experimentClient,this._sduiBufferService.get(),new C.R),this.addSubscription(this._alertProcessor.alerts.state.pipe(g.U(w.S.alertMapToCapiAlerts),o.h((e=>e.filter((e=>e.isHidden)).length>0)),p.P()).subscribe((()=>{const{upgradeHookExperiment:e,experimentGroup:t}=(0,P.o)(this._experimentClient);this._felog.upgradeHooksExp.upgradeHookFirstHiddenPremiumAlertReceived(e.name,t,this._domain)}))),this._checkingFeatureImpl.delayDisposeUntil(this._canDisposeCheckingServicePromise)}getUnmappedTextObserver(){return this._textObserver}addSubscription(e){this._isDisposed?e.unsubscribe():this._subs.push(e)}_checkDocContextSubscription(){var e;this._customizations.getDocEvents&&(null===(e=this._docEventsSubscription)||void 0===e||e.unsubscribe(),this._docEventsSubscription=this._customizations.getDocEvents(this._originalTextField).subscribe((e=>{var t,i;switch(e.type){case"docContextUpdated":{const i=this._sanitizeContextInfo(e.docContextInfo);(0,b.Qr)(i)||null===(t=this._checkingService.get())||void 0===t||t.updateContextInfo(i);break}case"published":null===(i=this._checkingService.get())||void 0===i||i.published();break;default:(0,m.vE)(e)}})),this._subs.push(this._docEventsSubscription))}_sanitizeContextInfo(e){const t=Object.keys(e),i=N.n.isGrammarlyEmployee(this._state.view("user").get());return t.reduce(((e,t)=>(z.t.fieldIsPrivate(t)&&!i&&delete e[t],e)),e)}}}}]);